import{V as H,g as P,y as S,z as V}from"./DkTpBWD-.js";import{e as I}from"./vIF72wqi.js";import{u as X}from"./BeLMco_p.js";var q=typeof global=="object"&&global&&global.Object===Object&&global,J=typeof self=="object"&&self&&self.Object===Object&&self,Q=q||J||Function("return this")(),T=Q.Symbol,_=Object.prototype,oo=_.hasOwnProperty,to=_.toString,v=T?T.toStringTag:void 0;function eo(e){var l=oo.call(e,v),i=e[v];try{e[v]=void 0;var f=!0}catch{}var g=to.call(e);return f&&(l?e[v]=i:delete e[v]),g}var no=Object.prototype,ao=no.toString;function so(e){return ao.call(e)}var lo="[object Null]",ro="[object Undefined]",k=T?T.toStringTag:void 0;function io(e){return e==null?e===void 0?ro:lo:k&&k in Object(e)?eo(e):so(e)}function co(e){return e!=null&&typeof e=="object"}var uo="[object Number]";function x(e){return typeof e=="number"||co(e)&&io(e)==uo}const ho=H("connections",()=>{const e=X(),l=S([]),i=S([]),f=S([]),g=S(null),p=S(!1),u=P("dataUsageMap",{sourceIP:{},host:{},process:{},outbound:{}}),j=P("dataUsageBaseline",{upload:0,download:0});let O=0,C=0;const b=new Map,E=(a,s)=>{const o=new Map;return s.forEach(t=>o.set(t.id,t)),a.map(t=>{const n=o.get(t.id);if(!n||!x(n.download)||!x(n.upload)){const r=t;return{...t,downloadSpeed:r.downloadSpeed??0,uploadSpeed:r.uploadSpeed??0}}return{...t,downloadSpeed:t.download-n.download,uploadSpeed:t.upload-n.upload}})},F=a=>{const s=new Set,o=[];for(const n of l.value)s.has(n.id)||(s.add(n.id),o.push(n));for(const n of a)s.has(n.id)||(s.add(n.id),o.push(n));const t=a.length+I;l.value=t>0&&o.length>t?o.slice(-t):o},$=(a,s)=>{const o=new Set(a.map(t=>t.id));return s.filter(t=>!o.has(t.id))},L=()=>{b.clear(),j.value={upload:0,download:0},console.log("[Data Usage] Connection tracking reset due to service restart")},D=()=>{u.value={sourceIP:{},host:{},process:{},outbound:{}},b.clear()},R=(a,s)=>{const o={...u.value},t={...o[a]};delete t[s],o[a]=t,u.value=o},Y=a=>{const s=a?new Set(a.map(o=>o.id)):new Set(l.value.map(o=>o.id));b.forEach((o,t)=>{s.has(t)||b.delete(t)})},Z=a=>{g.value=a;const s=a?.connections,o=a?.uploadTotal||0,t=a?.downloadTotal||0;if((o<O||t<C)&&(L(),D(),e.clearChartHistory()),O=o,C=t,!s||s.length===0)return;const n=E(s,i.value);if(A(n),Y(n),F(n),!p.value){const r=$(n,l.value);i.value=n,f.value=r.slice(-I)}},A=a=>{const s=g.value;s?.uploadTotal,s?.downloadTotal;const o={...u.value},t=Date.now(),n={sourceIP:new Map,host:new Map,process:new Map,outbound:new Map};a.forEach(r=>{const M=r.upload||0,w=r.download||0;let h=0,c=0;const m=b.get(r.id);if(m?(h=Math.max(0,M-m.upload),c=Math.max(0,w-m.download)):(h=M,c=w),b.set(r.id,{upload:M,download:w}),h===0&&c===0)return;const d=(B,y)=>{if(!y)return;n[B].has(y)||n[B].set(y,{upload:0,download:0});const U=n[B].get(y);U.upload+=h,U.download+=c};d("sourceIP",r.metadata.sourceIP||"Inner"),d("host",r.metadata.host||r.metadata.destinationIP),d("process",r.metadata.process||"Unknown");const K=r.chains&&r.chains.length>0?r.chains[0]:"DIRECT";d("outbound",K)}),Object.keys(n).forEach(r=>{const M=n[r],w={...o[r]};let h=!1;M.forEach((c,m)=>{h=!0;const d=w[m];d?w[m]={...d,upload:d.upload+c.upload,download:d.download+c.download,total:d.upload+c.upload+(d.download+c.download),lastSeen:t}:w[m]={type:r,label:m,upload:c.upload,download:c.download,total:c.upload+c.download,firstSeen:t,lastSeen:t}}),h&&(o[r]=w)}),u.value=o},W=V(()=>{const a={};return i.value.forEach(s=>{s.chains.forEach(o=>{a[o]||(a[o]=0),a[o]+=s.downloadSpeed})}),a});return{allConnections:l,activeConnections:i,closedConnections:f,latestConnectionMsg:g,paused:p,dataUsageMap:u,speedGroupByName:W,updateFromWsMsg:Z,clearDataUsage:D,removeDataUsageEntry:R,restructRawMsgToConnection:E}});let z={};const G=new WeakMap,N={metric:[{from:0,to:1e3,unit:"B",long:"bytes"},{from:1e3,to:1e6,unit:"kB",long:"kilobytes"},{from:1e6,to:1e9,unit:"MB",long:"megabytes"},{from:1e9,to:1e12,unit:"GB",long:"gigabytes"},{from:1e12,to:1e15,unit:"TB",long:"terabytes"},{from:1e15,to:1e18,unit:"PB",long:"petabytes"},{from:1e18,to:1e21,unit:"EB",long:"exabytes"},{from:1e21,to:1e24,unit:"ZB",long:"zettabytes"},{from:1e24,to:1e27,unit:"YB",long:"yottabytes"}],metric_octet:[{from:0,to:1e3,unit:"o",long:"octets"},{from:1e3,to:1e6,unit:"ko",long:"kilooctets"},{from:1e6,to:1e9,unit:"Mo",long:"megaoctets"},{from:1e9,to:1e12,unit:"Go",long:"gigaoctets"},{from:1e12,to:1e15,unit:"To",long:"teraoctets"},{from:1e15,to:1e18,unit:"Po",long:"petaoctets"},{from:1e18,to:1e21,unit:"Eo",long:"exaoctets"},{from:1e21,to:1e24,unit:"Zo",long:"zettaoctets"},{from:1e24,to:1e27,unit:"Yo",long:"yottaoctets"}],iec:[{from:0,to:Math.pow(1024,1),unit:"B",long:"bytes"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"KiB",long:"kibibytes"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"MiB",long:"mebibytes"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"GiB",long:"gibibytes"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"TiB",long:"tebibytes"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"PiB",long:"pebibytes"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"EiB",long:"exbibytes"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"ZiB",long:"zebibytes"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"YiB",long:"yobibytes"}],iec_octet:[{from:0,to:Math.pow(1024,1),unit:"o",long:"octets"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"Kio",long:"kibioctets"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"Mio",long:"mebioctets"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"Gio",long:"gibioctets"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"Tio",long:"tebioctets"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"Pio",long:"pebioctets"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"Eio",long:"exbioctets"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"Zio",long:"zebioctets"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"Yio",long:"yobioctets"}]};class po{constructor(l,i){i=Object.assign({units:"metric",precision:1,locale:void 0},z,i),G.set(this,i),Object.assign(N,i.customUnits);const f=l<0?"-":"";l=Math.abs(l);const g=N[i.units];if(g){const p=g.find(u=>l>=u.from&&l<u.to);if(p){const u=new Intl.NumberFormat(i.locale,{style:"decimal",maximumFractionDigits:i.precision}),j=p.from===0?f+u.format(l):f+u.format(l/p.from);this.value=j,this.unit=p.unit,this.long=p.long}else this.value=f+l,this.unit="",this.long=""}else throw new Error(`Invalid units specified: ${i.units}`)}toString(){const l=G.get(this);return l.toStringFn?l.toStringFn.bind(this)():`${this.value} ${this.unit}`}}function fo(e,l){return new po(e,l)}fo.defaultOptions=function(e){z=e};export{io as a,fo as b,Q as r,ho as u};
